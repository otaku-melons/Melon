# Разработка парсера
Разработка модуля парсера для Melon максимально упрощена, унифицирована и абстрагирована. Пройдите этот путь вместе с данным мануалом.

## Инструкция
### 0. Определения
Для лучшего понимания терминологии Melon рекомендуется ознакомиться с основными определениями, введёнными в процесс разработки.

| **Термин**                 | **Определение**                                                                                                                                                         |
|----------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Временный каталог парсера  | Директория с относительным путём `Temp/{PARSER}`. Используется для хранения временных файлов, необходимых парсеру, или загрузки изображений без спецификации пути. |
| Домашний каталог парсера   | Директория с относительным путём `Parsers/{PARSER}`. Также под этим может пониматься корень подмодуля Git.                                                         |
| Дополнение контента        | Процесс получения и записи в структуры описания глав контента (слайдов или абзацев).                                                                                    |
| Формат описательного файла | Набор правил о ключах и типах их значений в описательном файле JSON. Подробнее [здесь](/Docs/Examples).                                                                 |
| Коллекция                  | Текстовый файл _Collection.txt_ во временном каталоге парсера, содержащий список алиасов тайтлов, разделённых символом новой строки.                                    |
| Описательный файл          | Файл с расширением JSON, содержащий в себе все данные о конкретном тайтле в соответствии с одним из поддерживаемых форматов.                                            |

### 1. Базовые файлы
Домашний каталог парсера должен содержать следующие файлы:
* **main.py** – главный модуль и точка входа в парсер;
* **manifest.json** – манифест с определениями парсера.

Опциональны следующие файлы:
* **README.md** – описание дополнительных настроек парсера и особенностей использования;
* **.gitignore** – игнорируйте кэш Python и другие временные файлы Runtime и разработки;
* **install.sh** или **install.bat** – скрипт, выполняющийся после клонирования репозитория (для Linux и Windows соответственно);
* **requirements.txt** – если парсер имеет специфические зависимости PyPI, не определённые в [Melon](https://github.com/Otaku-Melons/Melon/blob/main/requirements.txt), укажите их здесь;
* **LICENSE** или **LICENSE.txt** – поставляйте лицензию для вашего Open Source модуля, чтобы явно указать все аспекты использования;
* **settings.json** – при необходимости, определите по умолчанию дополнительные параметры.

### 2. Инициализация каталога
Melon поддерживает два типа контента: манга и ранобэ.

Воспользуйтесь командой `melon init -p {PARSER} --content {TYPE}` для автоматической генерации всех необходимых файлов парсера выбранного типа контента, где `PARSER` – название парсера, а `TYPE` – тип контента (_manga_, _ranobe_). Название парсера должно содержать только символы латинского алфавита в нижнем регистре и цифры!

В _main.py_ находится класс **Parser**, унаследованный от соответствующего типа, внутри которого необходимо выполнить реализацию парсера.

Версия парсера определяется в манифесте, но вместо конретного значения можно указать директивы:
* `$last_git_tag` – берёт версию из последнего тега репозитория;
* `$from_parser:{PARSER}` – берёт версию определённого парсера.

В файле _settings.json_ можно указать стандартные параметры или определить дополнительные в секции `custom`. Не забывайте описывать их в соответствующей секции _README.md_.

### 3. Внедрение функционала
Для базового функционирования вам необходимо переопределить методы `amend()` и `parse()` из родительского класса (также можно переопределить `image` в качестве кастомного загрузчика изображений). Не изменяйте список принимаемых аргументов! Опционально вы можете имплементировать метод `collect` для сборки алиасов тайтлов в файл по шаблону ниже. Могут использоваться следующие параметры:
* _period_ – период сбора обновлений в часах;
* _filters_ – строка для дополнительных способов фильтрации (обычно параметры запроса);
* _pages_ – количество страниц каталога, с которых нужно получить данные.

Поддержка этих параметров является опциональной.

#### collect
```Python
def collect(self, period: int | None = None, filters: str | None = None, pages: int | None = None) -> Iterable[str]:
	"""
	Собирает список алиасов тайтлов по заданным параметрам.

	:param period: Количество часов до текущего момента, составляющее период получения данных.
	:type period: int | None
	:param filters: Строка, описывающая фильтрацию (подробнее в README.md парсера).
	:type filters: str | None
	:param pages: Количество запрашиваемых страниц каталога.
	:type pages: int | None
	:return: Набор собранных алиасов.
	:rtype: Iterable[str]
	"""

	pass
```

Хранение данных внутри парсера происходит при помощи абстракции над строго задокументированным форматом JSON соответствующего типа, информацию о котором можно найти [здесь](/Docs/Examples). Доступ осуществляется через наследуемый атрибут **self._Title**.

Для выполнения запросов рекомендуется использовать библиотеку [dublib](https://github.com/DUB1401/dublib) и её модуль `WebRequestor`. Вы можете определить собственные параметры запросчика через наследуемый метод **_InitializeRequestor** по примеру из родительского [объекта](/Source/Core/Base/BaseParser.py).

При необходимости добавления чего-то в инициализацию объекта можно переопределить **_PostInitMethod**, вызывающийся сразу после **\_\_init\_\_** родительского класса.

### 4. Порталы
Для работы с CLI, логами, временными файлами и настройками предоставляются так называемые порталы и объектные имплементации, позволяющие выводить и использовать данные в унифицированном формате. Каждый парсер на разных этапах своей работы может использовать самодокументируемые порталы, определённые в объекте **self._Portals**.

Порталы совмещают вывод в консоль и доступ к логам, что позволяет обрабатывать их при помощи файлов конфигурации (см. [Настройка логов](/Docs/LOGGER.md)).

В некоторых случаях парсер также обязан выбрасывать исключения, которые используются Melon для корректной обработки процесса получения контента. Порталы ошибок по умолчанию выбрасывают соответствующие исключения, но такое поведение можно отключить, передав соответствующий аргумент.

#### Порталы временных файлов
Парсеру может понадобиться хранить какие-либо сторонние файлы, тебующиеся обработчику контента (например _Collection.txt_), и, чтобы не засорять домашний каталог, доступен портал для лёгкого получения доступа к директории _Temp_. Для каждого парсера внутри данной директории создаётся свой подраздел.
```Python
# Получение пути к каталогу временных файлов парсера.
Path = self._Temper.parser_temp
# Скачивание изображения во временный каталог парсера.
Filename = self._ImagesDownloader.temp_image("https://link_to_image")
# Очистка каталога временных файлов парсера.
self._Temper.clear_parser_temp()
```

#### Настройки
Доступ к настройкам парсера осуществляется через абстракцию `ParserSettings`.

```Python
self._Settings.common.delay
self._Settings.proxy.enabled
self._Settings.filters.text.clear("Some text.")
self._Settings.custom["key"]
```

### 5. Рекомендации
Как и любой хороший Open Source проект, Melon имеет ряд рекомендаций по чистоте кода парсеров, а также взаимодействию модулей и их структуре. Следуя им, вы однозначно повысите качество интеграции своего парсера с системой.

| **Номер** | **Описание** |
|---|---|
| 1 | Парсер должен выполнять все файловые операции внутри своих рабочих директорий, определённых настройками, а также во временном каталоге. |
| 2 | Все сетевые запросы парсера должны поддерживать проброс через прокси-сервер. Это позволяет обходить региональные ограничения. |
| 3 | Следует по возможности использовать только порталы CLI/логов для общения с пользователем и унификации интерфейса (к расширениям это относится в меньшей степени). |
| 4 | Ограничивайте частоту запросов к серверу: это позволяет не только избежать блокировок, но и не создаёт избыточную нагрузку на источник контента, что является хорошим тоном. |
| 5 | Всегда указывайте в описательных файлах авторов и переводчиков, если таковые известны. Уважайте чужой труд. |
| 6 | Парсер должен опираться на предоставляемые Melon методы, порталы, имплементации и абстракции. Это избавляет вас от изобретения велосипеда и позволяет длительное время поддерживать парсер в актуальном состоянии. |
| 7 | Домашний каталог парсера должен являться неизменяемым. Все настройки определяются в `Configs/{PARSER}/settings.json`, а временные файлы в `Temp/{PARSER}`. Поддерживайте чистоту. |
| 8 | Весь сторонний функционал, не использующийся для реализации стандартных функций Melon, должен быть вынесен в расширения (см. [Поставка расширений](./EXTENSIONS.md)). |

### 6. Работа с парсером
Такие вещи, как CLI, логи, протоколы общения модулей, а также работа с данными ложатся на плечи Melon. Он следит за валидностью, стилистикой и иногда корректностью рабочего процесса и выходных данных. Предоставив парсер и правильно его настроив, вы можете использовать его так же непринуждённо, как и встроенные модули.